# Implementation Plan: YNAB Smart Budget Management

**Branch**: `004-ynab-smart-budget` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-ynab-smart-budget/spec.md`

## Summary

Add YNAB write operations (recategorize transactions, create manual transactions, adjust budgets), proactive spending insights (overspend warnings, uncategorized nudges, anomaly detection), and upgrade the assistant model from Sonnet 4 to Opus for deeper financial reasoning. All interactions via the existing WhatsApp bot with Claude tool loop.

## Technical Context

**Language/Version**: Python 3.12 (existing codebase)
**Primary Dependencies**: FastAPI, anthropic SDK (Claude Opus), httpx (YNAB API calls), notion-client >=2.2.0,<2.3.0
**Storage**: YNAB API (external, transactions + budgets), Notion Nudge Queue (budget insights as nudges)
**Testing**: Manual validation via WhatsApp + curl endpoint tests
**Target Platform**: Docker Compose on NUC (Linux, amd64)
**Project Type**: Web service (existing FastAPI app)
**Performance Goals**: Transaction operations < 15 seconds, budget scan < 30 seconds
**Constraints**: YNAB API rate limit 200 requests/hour; cache category/payee lists to minimize calls
**Scale/Scope**: 2 users, <500 messages/month, <50 budget-related queries/day

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Integration Over Building | PASS | Uses YNAB's own API for all budget operations — no custom budget tracking |
| II. Mobile-First Access | PASS | All interactions via WhatsApp on iPhone — zero desktop required |
| III. Simplicity & Low Friction | PASS | Natural language via chat: "move $100 from Dining to Groceries" — 1 message |
| IV. Structured Output | PASS | Transaction lists, budget summaries, and insights formatted as scannable lists |
| V. Incremental Value | PASS | US1 (transactions) works standalone, US2 (insights) works standalone, US3 (rebalancing) works standalone, US4 (model) is independent config change |

No violations. All principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/004-ynab-smart-budget/
├── plan.md              # This file
├── research.md          # YNAB API research + architecture decisions
├── data-model.md        # YNAB entities + caching strategy
├── quickstart.md        # Setup and validation guide
├── contracts/
│   └── budget-endpoints.md  # API endpoint + tool definitions
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── tools/
│   └── ynab.py          # Extended: +5 write functions, +5 helpers, +caching
├── app.py               # Extended: +1 endpoint (POST /api/v1/budget/scan)
├── assistant.py         # Extended: +5 tool defs, model upgrade, system prompt
└── config.py            # No changes needed (YNAB config already exists)
```

**Structure Decision**: All changes are additions to existing files. No new files needed — `ynab.py` already exists and will be extended with write operations, caching, and insight generation. The budget scan endpoint goes in `app.py` alongside the existing nudge scan endpoint.

## Key Implementation Decisions

### 1. Caching (R3, research.md)

Category and payee lists are cached in-memory with a 1-hour TTL to minimize API calls. Cache is a module-level dict with timestamp. Invalidated on TTL expiry or explicit refresh.

### 2. Transaction Search (R2, research.md)

YNAB API has no free-text search. The flow is:
1. Fetch transactions for current month (`since_date`)
2. Client-side filter by payee name (case-insensitive contains)
3. Optional filter by amount range, category, or uncategorized status
4. Return formatted list sorted by date descending

### 3. Budget Move (R4, research.md)

Two-step process:
1. GET both categories' current budgeted amounts
2. PATCH source (budgeted - amount), PATCH destination (budgeted + amount)
3. Validate source has sufficient budget before PATCHing

### 4. Proactive Insights (R5, research.md)

Budget insights run as a daily n8n cron (9am Pacific). Insights are stored in the existing Nudge Queue as `nudge_type="budget"`. They respect quiet day, quiet hours, and daily cap from Feature 003.

Daily checks: overspend warning (>80% before 20th), uncategorized pile-up (3+ > 48h).
Weekly checks (Monday only): spending anomaly (50%+ above 3-month average), savings goal gaps.

### 5. Model Upgrade (R6, research.md)

Single constant change: `claude-sonnet-4-20250514` → `claude-opus-4-20250514`. Estimated cost increase: $3/month → $15/month at current volume. Well within $75/month budget.

## Phases

### Phase 1: Setup
- Model upgrade in assistant.py (US4 — 1 line change, immediate value)

### Phase 2: Foundational
- YNAB API helpers: category cache, payee cache, account lookup, fuzzy matching
- These block all write operations

### Phase 3: US1 — Transaction Management
- search_transactions, recategorize_transaction, create_transaction
- Register tools in assistant.py with system prompt updates

### Phase 4: US3 — Budget Rebalancing
- update_category_budget, move_money
- Register tools in assistant.py

### Phase 5: US2 — Smart Spending Insights
- Budget scan endpoint in app.py
- Overspend detection, uncategorized nudge, anomaly detection, goal gap tracking
- n8n workflow WF-010

### Phase 6: Polish
- System prompt refinements for budget conversation tone
- Deploy and validate
