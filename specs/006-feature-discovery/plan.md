# Implementation Plan: Feature Discovery & Onboarding

**Branch**: `006-feature-discovery` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-feature-discovery/spec.md`

## Summary

Add feature discovery and onboarding to Mom Bot — when Erin says "help" or "what can you do?", the bot responds with a categorized list of all capabilities using personalized examples from real family data. Includes "did you know?" contextual tips after relevant responses, a one-time welcome message for new users, and passive usage tracking that surfaces underused features. Implemented through one new tool module, system prompt updates, and lightweight JSON-based persistence.

## Technical Context

**Language/Version**: Python 3.12 (existing codebase)
**Primary Dependencies**: FastAPI, anthropic SDK (Claude Opus), notion-client >=2.2.0,<2.3.0
**Storage**: Notion (existing databases — no new databases needed), in-memory set for welcome tracking, JSON file (`data/usage_counters.json`) for persistent usage counters
**Testing**: Manual validation via WhatsApp + curl
**Target Platform**: Docker Compose on NUC (Linux, amd64)
**Project Type**: Web service (existing FastAPI app)
**Performance Goals**: Help response < 15 seconds (includes 1-2 tool calls for personalization)
**Constraints**: WhatsApp message length limits; single-message stateless processing
**Scale/Scope**: 2 users, <500 messages/month

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Integration Over Building | PASS | Uses existing tools (list_cookbooks, get_staple_items, get_budget_summary) for personalization — no new external services |
| II. Mobile-First Access | PASS | All interactions via WhatsApp on iPhone — help menu formatted for mobile readability |
| III. Simplicity & Low Friction | PASS | "help" → instant categorized response. Zero setup, zero configuration. Tips are passive (appended, not pushed) |
| IV. Structured Output | PASS | Help menu uses bold headers, emoji icons, bullet points, grouped by category — scannable in 30 seconds |
| V. Incremental Value | PASS | US1 (help menu) works standalone. US2 (tips) adds passive discovery. US3 (welcome) adds polish. US4 (usage tracking) enhances US1+US2 but doesn't gate them. Each independently useful |

No violations. All principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/006-feature-discovery/
├── plan.md              # This file
├── research.md          # Implementation approach decisions
├── data-model.md        # Help categories, tips, session state
├── quickstart.md        # Setup and validation guide
├── contracts/
│   └── help-tool.md     # get_help tool definition
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── tools/
│   └── discovery.py     # NEW: get_help(), tips, usage counters, TOOL_TO_CATEGORY mapping
├── assistant.py          # Extended: +1 tool def, system prompt updates, welcome logic, usage recording
└── config.py             # No changes needed
data/
└── usage_counters.json   # NEW: persistent usage counters (phone → category → count + last_tip)
docker-compose.yml        # Extended: +1 volume mount (./data:/app/data)
```

**Structure Decision**: One new file (`discovery.py`) for help content generation, tip definitions, and usage tracking. This keeps discovery logic separate from the 22 existing tools. A `data/` directory with Docker volume mount provides lightweight persistence for usage counters without adding a database. System prompt and tool registration changes go in `assistant.py` as additions to existing sections.

## Key Implementation Decisions

### 1. Help Response Strategy (R1, R6, research.md)

Use a `get_help()` tool function that builds a personalized help menu. When Claude detects a help request, it calls `get_help()` which fetches live data (cookbooks, staple items) and returns a formatted response. Falls back to hardcoded family-relevant examples if data fetching fails.

### 2. Tip System (R2, R3, research.md)

System prompt instructions tell Claude when to append tips. A static mapping of trigger contexts → tips lives in `discovery.py`. Claude picks from matching tips, preferring tips about underused categories when usage data is available. Last-shown tip ID is tracked per user in the usage counters file to avoid consecutive repeats.

### 3. First-Time Detection (R4, research.md)

Module-level `_welcomed_phones: set[str]` in `assistant.py`. Checked in `handle_message()` before calling Claude. On first contact, a brief welcome is prepended to the system message. Resets on container restart (harmless — welcome may re-show once).

### 4. Personalization Sources (R5, research.md)

Live data from existing tools: `list_cookbooks()`, `get_staple_items()`, `get_budget_summary()`. Static fallbacks use known family data: "Costco", "chicken dinner", "Groceries budget".

### 5. Usage Tracking & Smart Suggestions (US4)

Passive usage counters stored in `data/usage_counters.json` — a flat JSON file mapping `{phone: {category: count, "_last_tip": "tip_id"}}`. Updated after every successful tool call by mapping tool name → category via `TOOL_TO_CATEGORY`. The `get_help()` and `get_contextual_tip()` functions accept an optional `phone` parameter to leverage usage data for smarter suggestions. Docker volume mount (`./data:/app/data`) ensures persistence across container restarts.

## Phases

### Phase 1: Help Menu (US1)
- Create `src/tools/discovery.py` with help categories, static examples, personalization logic
- Implement `get_help()` function that fetches live data and builds formatted response
- Register `get_help` tool in `assistant.py`
- Add system prompt rules for help trigger detection

### Phase 2: "Did You Know?" Tips (US2)
- Add tip definitions to `discovery.py` (trigger context → tip text mapping)
- Add `get_contextual_tip(tools_used)` helper function
- Add system prompt rules for tip appending (max 1 per response, contextually relevant)

### Phase 3: First-Time Welcome (US3)
- Add `_welcomed_phones` set to `assistant.py`
- Add welcome check in `handle_message()` before Claude call
- Prepend welcome message on first contact

### Phase 4: Usage Tracking & Smart Suggestions (US4)
- Add `data/` directory with Docker volume mount for persistence
- Implement usage counter load/save in `discovery.py` (JSON file)
- Add `record_usage(phone, tool_name)` — called after each tool invocation in `assistant.py`
- Add `get_underused_categories(phone)` — returns categories with zero usage
- Enhance `get_help()` and `get_contextual_tip()` to accept `phone` and prioritize underused categories
- Track last-shown tip ID per user to avoid consecutive repeats

### Phase 5: Polish & Deploy
- System prompt refinements for natural help/tip phrasing
- Deploy and validate all test scenarios
